# Bot作成(node.js編)チュートリアル
## 1. 注意事項
このチュートリアルを行うには以下の環境がひつようになります。
- MacOSX or Linux PC
- node.js環境、npm環境
- VisualStudioCode(node.jsが開発できる環境ならなんでもいいですがオススメ)
- Microsoft Imagineのライセンス
- Microsoft Azureの環境
- Dropbox、OneDrive、Githubのどれかのアカウント

まだ準備ができていない人はスタッフまで声をかけてください。

このチュートリアルには

- **学習価値のある一般技術知識**
- **ハッカソンでしか使えない技術知識**

の2つの情報が含まれています。

**学習価値のある一般技術知識**  は一般的に通用しているMicrosoftの技術知識です。ほかに応用が利くのでハッカソンを通して学習してもらえればと思います。

**ハッカソンでしか使えない技術知識**  今回、ハッカソンでアイデアを実現するために様々なライブラリや環境を用意しています。なのでこの知識は覚える必要はありません。ハッカソンで使ってあとは忘れてください。

## 2. セットアップ
### 2.1 プロジェクトを開く

VisualStudioCodeを起動し、[ファイル]>[開く]から、ダウンロードした201612hackathonyokohama/nodejs/SampleBotフォルダを開きます。

server.jsが左のリストに出ている状態にしてください。

![1](./img/1.png)

このプロジェクトに入っているプログラムは下記の用になっています。

- **apikey.json**: WebAPIのAPIキーを入れるファイル
- **apisamples.js**: apiテスト用のnodejsコンソールプログラム
- **cognitive.js**: cognitive serviceのnode.jsライブラリ実装
- **docomoapi.js**: docomoAPIのnode.jsライブラリ実装
- **index.html**: Botのサーバーにアクセスしたときに表示されるhtml
- **package.json**: node.jsに必要なパッケージの情報が入っているファイル
- **rule.csv**: Botの応答ルールを記述できるcsvファイル
- **server.js**: Botのメインサーバープログラム

つまり、主に見るべきファイルは**server.js**です。

ダウンロードした状態では、node.jsのパッケージに足りないものが存在するので、package.jsonにある情報からパッケージを復元します。

VisualStudioCodeのメニューバーから、[表示]>[統合ターミナル]を表示します。

![26](./img/26.png)

ターミナルを表示することができます。

![27](./img/27.png)

では以下のコマンドターミナルに打ち込んで、nodeパッケージを復元します。

```sh
npm install
```

![28](./img/28.png)

これで足りないnodeパッケージを復元できました。

### 2.2 Botのサーバーを作る
**学習価値のある一般技術知識**

Botはサーバー上で動くため、ホスティングするサーバーを立てなければなりません。
今回はMicrosoft Azureというクラウド上に、学生ライセンスを使って無料でホスティングを行います。

[http://portal.azure.com](http://portal.azure.com)にアクセスし、**MicrosoftImagineで学生認証を行ったMicrosoftアカウントでサインイン**します。

以下のような画面が表示されればOKです。

![2](./img/2.png)

Webサーバーを作ります。Microsoft AzureではWebサーバーなどの資源は**リソース**として管理されます。
そしてMicrosoft AzureのWebサーバーは**Web App**というリソースになります。
Web Appを新規作成しましょう。

左上の**+新規**>**Web+モバイル**>**Web App**を選択します。

![3](./img/3.png)

下図のような画面が出るので

- アプリ名 - お好きなIDを入力
- サブスクリプション - Microsoft Imagineを選択
- リソースグループ - 新規作成、**MyBotGroup**と入力
- App Serviceプラン/場所 - 後述

を入力します。

アプリ名は他人と被らないものを入力してください。右側に緑色のチェックマークが表示されればOKです。

アプリ名.azurewebsites.netがBotのURLとなります。

サブスクリプションの選択で**Microsoft Imagine**が表示されない方は学生認証の準備をしていない可能性があります。速やかに手を挙げてスタッフを呼んでください。

![4](./img/4.png)

**App Serviceプラン 場所**をクリックすると下図のようになります。**新規作成**を押し

- App Service プラン - お好きなIDを入力
- 場所 - Japan Eastを選択
- 価格レベル - F1 Freeを選択

を入力し、OKを押します。

![5](./img/5.png)

ここまでできたら**作成**を押します。

右上のベルマークに**デプロイメントが成功しました**と表示されればOKです。

![6](./img/6.png)

作成したWebサイトを見てみましょう。
左側の**すべてのリソース**から先ほど作成したIDをクリックします。

![7](./img/7.png)

先ほど作成したWebAppの管理画面が表示されます。
URLが表示されているのでURLをクリックします。

![8](./img/8.png)

Webサイトを表示することができました。
デフォルトで用意されているページが表示されているはずです。

![9](./img/9.png)

続いてWebAppsのnode.jsのバージョンを上げましょう。デフォルトでは4.4.7とバージョンが古いので、新しいバージョンにする必要があります。

作成したWebAppの管理画面から[アプリケーション設定]を押します。

![33](./img/33.png)

アプリケーション設定の画面を下の方にスクロールすると、[アプリ設定]という項目に[WEBSITE_NODE_DEFAULT_VERSION]というキーがあります。そこの値を**7.2.0**に書き換えます。書き換えることができたら、左上の[保存]ボタンをおします。

![34](./img/34.png)

これでWebAppのnode.jsのバージョンをアップグレードできました。

### 2.3 BotをBot Connectorに新規登録する
**学習価値のある一般技術知識**

Microsoft BotFrameworkでは[Bot Connector](http://www.atmarkit.co.jp/ait/articles/1604/15/news032.html)というものを利用して、自分のBotを配置したWebサーバーとslackやSkypeなどのメッセンジャーサービスをつなげることができます。

なのでBotをメッセンジャーサービスにつなげるには、必ずBot Connectorに登録しなければいけません。

![10](./img/10.png)

[BotFrameworkの公式サイト](https://dev.botframework.com)にアクセスします。

**Register a bot**をクリックします。

![11](./img/11.png)

Microsoftのアカウントでのサインインを求められた場合、ご自身のMicrosoftアカウントでサインインしてください。

Botの新規登録ページが出てきたら下記の情報を入力してください。

- **Icon**:Botのアイコンになります。好きなアイコンにしたければ30K以下のpngファイルを指定してください。特に気にならなければ何も指定しなくてOK
- **Name**: Botの名前。好きな名前をどうぞ
- **Bot handle**:BotのIDになります。他と被らない好きなIDを入れます。
- **Description**:詳細説明。テキトーなことを書いてOK

![12](./img/12.png)

- **Messaging endpoint**:Botを配置したWebAppのURL。

```
https://{webappのID}.azurewebsites.net/api/Messages

```

を入力(↑**httpsなところに注意！**)

できたら**Create Microsoft App ID and password**ボタンを押します。

![13](./img/13.png)

新しくタブが開くと、すでにアプリ名とアプリIDが入力されていると思います。

**アプリIDをどこかにメモしてください**

**アプリパスワードを作成して続行**ボタンを押します。

![14](./img/14.png)

新しくパスワードが作成されましたという表示の元、Botのアプリパスワードが表示されます。

**このパスワードは1回しか表示されないのでかならずどこかにメモしてください**

(パスワードを忘れた場合再発行になります)

**OK**をおしてダイアログを閉じます

![15](./img/15.png)

**終了してボットのフレームワークに戻る**を押します。

戻ると、アプリIDが入力されています

Adminの項目は何も入力しなくてもOKです。

一番下の**By clicking Register ～**の部分にチェックをいれ、**Register**ボタンを押してBotを新規登録します。

![16](./img/16.png)

**Bot created**と表示されればOKです。**OK**ボタンをおします。

![17](./img/17.png)

BotをBot Connectorに新規登録できました。

![18](./img/18.png)

この時点で

- BotのMicrosoft App Id
- BotのMicrosoft App password

がどこかにメモできているでしょうか。
メモできていなければ、上の手順を読み直して、Botを再度作成してください。

### 2.4 BotのIDとパスワードをBotのプログラムに入れる
**ハッカソンでしか使えない技術知識**

Botを動かすためには、先ほど取得したBotのIDとpasswordを開発しているBotのプログラムに入力する必要があります。

今回はapikey.jsonというファイルにBotのIDとパスワードを入れると、自動で読み込むようなプログラムを作っておきました。
なので、apikey.jsonを編集すればIDとパスワードを読み込むことができます。

apikey.jsonを開き、**BOT_ID**には先程メモしたBotのMicrosoft App IDを、**BOT_PASSWORD**には先程メモしたBotのMicrosoft App Passwordを入れてください。

![19](./img/19.png)

### 2.5 その他のWebAPIKeyを入れる
**ハッカソンでしか使えない技術知識**

ダウンロードしたSampleBotプロジェクトは、今回ハッカソンで使用する各種WebAPIのAPIKeyが入っていないため、ビルド(プログラムを実行ファイルにすること)ができません。

そこでまずはWebAPIのApiKeyを入力しましょう。
その他のWebAPIKeyも、先程と同じapikey.jsonファイルに書き込みます

各種APIKeyはスタッフから指示があるまでお待ちください。

このようにAPIKeyが埋まればOKです。

![20](./img/20.png)

### 2.6 Botをサーバーに配置する
**学習価値のある一般技術知識**

今回開発するBotはMicrosoftの[BotFramework](https://dev.botframework.com/)というものを使用して開発します。
BotFrameworkはC#とnode.jsの2種類の開発方法がありますが、node.jsでの開発の場合、node.jsのサーバーを起動し、それをBotサーバーとして利用することとなります。

なのでnode.jsでのBot開発の場合は、node.jsのサーバーを起動することと同じ操作で、Botサーバーを起動することができます。

先程Microsoft Azureで作成したWebAppは、node.jsも公式でサポートしており、配置されたファイルの中にあるserver.jsファイルを自動でnode.jsのサーバーとして起動してくれます。

なので今回の場合、server.jsファイルを含め、**SampleBotフォルダの中にある全てのファイルをWebApp上に配置**することでBotサーバーを起動できます。

ではどうやってnode.jsのプログラムをWebAppsに配置するかですが、WebAppsでは**Dropboxなどのクラウドストレージを利用してWebアプリをサーバーに配置**することができます。

では実際に配置していきましょう。

Azureの管理ポータル([portal.azure.com](http://portal.azure.com))に戻り、先程作成したWebAppの管理画面を表示し、[デプロイ オプション]を選択します。

![21](./img/21.png)

[ソースの選択]を選択します。
様々なサービスが出ますが、Dropbox、OneDrive、GitHubの中で自分の使っているサービスを選択してください。（できれば同期クライアントアプリをいれていること）

今回はDropboxで解説をしますが、基本的な操作はほかも同じです。

では[Dropbox]を選択します。

![22](./img/22.png)

Dropboxのアカウント認証が入るので、アカウント認証をしましょう。

すると下図のような画面になるので[OK]を押します。

![23](./img/23.png)

右上のベルマークに[デプロイ元は正常にセットアップされました]と表示されたらOKです。

![24](./img/24.png)

すると、Dropboxのルートフォルダ/アプリ/Azure/{自分のWebAppのID}のフォルダが作成されているはずです。

![25](./img/25.png)

ここに、**node_moduleフォルダ**以外のnode/SampleBotにあるファイルをコピーします。

![29](./img/29.png)

ファイルが同期されたら、再びWebAppの管理画面(Azure)へ戻り、[デプロイオプション]>[同期]>[はい]を押します。

![30](./img/30.png)

しばらく待つと、Synchronizedと表示され、DropboxのフォルダからWebAppへの配置が始まります。(ボタンを押してもなかなか始まらない場合は何回か押して見るのがよいかもです)

![31](./img/31.png)

Synchronizedの表示が緑色のチェックマークになったら、配置完了です。

![32](./img/32.png)

This is the bot pageと表示されたページが表示されればOKです。

![35](./img/35.png)

このようにDropboxにファイルを入れて、ボタン1つでWebアプリをサーバーに配置する機能がWebAppにはあります。

### 2.7 Botと対話してみる
**学習価値のある一般技術知識**

ここまでで、ついにBotをサーバーに配置し、対話できる状態になりました。
では実際に対話してみましょう。

再び[dev.botframework.com](https://dev.botframework.com/)にアクセスします。

自分が先ほど作成したBotを表示するために**My bots**をクリックします。

![36](./img/36.png)

先ほど作成したBotの名前をクリックします。

![37](./img/37.png)



## 4. おわりに
お疲れ様でした。チュートリアルは以上となります。

以降は様々な機能を駆使して、オリジナルなBotのアイデアを実現していきましょう。

### 4.1 あまりプログラミングが得意ではない人
基本的にはrule.csvファイルのルールを編集するだけでBotの応答ルールは変えることができます。まずはそこから初めて、Botにどういう応答をしてほしいかを考えながら進めていきましょう。プログラムと連携したいときはスタッフを呼んでください。

### 4.2 プログラミングがそこそこ得意な人
command機能やcognitive service、docomoのAPIなどを駆使して面白いアイデアを実現していきましょう。コピペでエラーなどが出たらスタッフを呼んでいただければ対処します。サンプルコード集はこちらです。[COPYCODE.md](./COPYCODE.md)

### 4.3 プログミングが得意な人
オリジナルなアイデアで賞をめざしてください！余裕があれば、周りで困っている人を助けてもらうとうれしいです。